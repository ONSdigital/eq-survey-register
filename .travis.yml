language: go

go:
  - 1.8.1

services:
  - docker

script:
  - set -e
  - ./scripts/lint.sh
  - go get -u github.com/golang/dep/cmd/dep
  - dep ensure
  - go test
  - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
  - export TAG=`if [ "$TRAVIS_PULL_REQUEST_BRANCH" == "" ]; then echo "latest"; else echo $TRAVIS_PULL_REQUEST_BRANCH; fi`
  - docker run -v "$(pwd):/src" -v /var/run/docker.sock:/var/run/docker.sock jonnyshaw89/golang-builder onsdigital/eq-survey-register:$TAG
  - echo "Pushing with tag [$TAG]"
  - docker push onsdigital/eq-survey-register:$TAG

branches:
  only:
    - master